# Docker Compose for local development and testing
# Usage: docker-compose up -d

services:
  # Kafka with Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_MESSAGE_MAX_BYTES: 10485760
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 10

  # RTSP Server (MediaMTX)
  rtsp-server:
    image: bluenviron/mediamtx:latest
    container_name: rtsp-server
    ports:
      - "8554:8554"
    environment:
      - MTX_PROTOCOLS=tcp

  # FFmpeg streamer - streams video file to RTSP server
  ffmpeg-streamer:
    image: linuxserver/ffmpeg:latest
    container_name: ffmpeg-streamer
    depends_on:
      - rtsp-server
    volumes:
      - ./test-data/sample.mp4:/media/video.mp4:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for RTSP server to start..."
        sleep 10
        echo "Starting video stream loop..."
        while true; do
          ffmpeg -re -stream_loop -1 -i /media/video.mp4 -c:v libx264 -preset ultrafast -tune zerolatency -c:a aac -f rtsp -rtsp_transport tcp rtsp://rtsp-server:8554/stream
          echo "FFmpeg exited, restarting in 2s..."
          sleep 2
        done
    restart: unless-stopped

  # LocalStack for S3 emulation
  localstack:
    image: localstack/localstack:3.0
    container_name: localstack
    ports:
      - "4566:4566"
    environment:
      SERVICES: s3
      DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    volumes:
      - "./localstack-init:/etc/localstack/init/ready.d"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Inference Service
  inference:
    build:
      context: ./services/inference
      dockerfile: Dockerfile
    container_name: inference-service
    ports:
      - "8000:8000"
    environment:
      INFERENCE_MODEL_NAME: yolov8n.pt
      INFERENCE_CONFIDENCE_THRESHOLD: "0.5"
      INFERENCE_MAX_BATCH_SIZE: "25"
      INFERENCE_MODEL_DEVICE: cpu
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      start_period: 90s
      retries: 10

  # Consumer
  consumer:
    build:
      context: ./services/consumer
      dockerfile: Dockerfile
    container_name: consumer
    depends_on:
      kafka:
        condition: service_healthy
      inference:
        condition: service_healthy
      localstack:
        condition: service_healthy
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_TOPIC: video-frames
      KAFKA_GROUP_ID: frame-consumer-group
      KAFKA_AUTO_OFFSET_RESET: earliest
      INFERENCE_SERVICE_URL: http://inference:8000
      S3_BUCKET: video-pipeline-output
      S3_PREFIX: annotated
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_ENDPOINT_URL: http://localstack:4566
      BATCH_SIZE: "25"
      BATCH_TIMEOUT_SECONDS: "5.0"

  # Producer (optional, can run separately)
  producer:
    build:
      context: ./services/producer
      dockerfile: Dockerfile
    container_name: producer
    depends_on:
      kafka:
        condition: service_healthy
      rtsp-server:
        condition: service_started
    environment:
      RTSP_URL: rtsp://rtsp-server:8554/stream
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_TOPIC: video-frames
      FRAME_RATE: "10"
      JPEG_QUALITY: "85"
    profiles:
      - with-producer

networks:
  default:
    name: video-pipeline-network

volumes:
  kafka-data:
  localstack-data:

